(function(){"use strict";const e=window.Vue;function E(){return window.panel}const R=()=>window.panel.plugins.viewButtons!==void 0;function D(){return R()?new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}}):E().app.$store}function K(){const s=E(),o=D(),n=R();if(n&&!("diff"in s.content))throw new Error("This plugin requires Kirby 5.0.0-rc.1 or higher. Please update your Kirby installation.");const t=y(n?()=>s.content.version("changes"):()=>o.getters["content/values"]()),i=y(n?()=>s.content.diff():()=>o.getters["content/changes"]()),r=y(n?()=>s.content.hasDiff():()=>o.getters["content/hasChanges"]()),a=n?s.content:new Proxy({},{get(){return()=>{}}});return{content:a,currentContent:t,contentChanges:i,hasChanges:r,update:async(f,g=!0)=>{if(!n&&f)for(const[h,b]of Object.entries(f))o.dispatch("content/update",[h,b]);const d=a.merge(f);g&&await a.save(d)}}}const y=e.computed;e.customRef,e.defineAsyncComponent,e.defineComponent,e.effectScope,e.getCurrentInstance;const M=e.getCurrentScope;e.h,e.inject,e.isProxy,e.isReactive,e.isReadonly,e.isRef,e.isShallow,e.markRaw;const U=e.nextTick;e.onActivated,e.onBeforeMount,e.onBeforeUnmount,e.onBeforeUpdate,e.onDeactivated,e.onErrorCaptured,e.onMounted,e.onRenderTracked,e.onRenderTriggered;const A=e.onScopeDispose;e.onServerPrefetch,e.onUnmounted,e.onUpdated,e.provide,e.proxyRefs,e.reactive,e.readonly;const _=e.ref;e.shallowReactive,e.shallowReadonly,e.shallowRef,e.toRaw,e.toRef,e.toRefs,e.triggerRef;const z=e.unref;e.useAttrs,e.useCssModule,e.useCssVars,e.useListeners,e.useSlots;const O=e.watch;e.watchEffect,e.watchPostEffect,e.watchSyncEffect;const V={heading:"title",text:"text",image:"image",gallery:"dashboard",video:"video",code:"code",quote:"quote",markdown:"markdown",list:"list-bullet",line:"divider",table:"menu"},j="k-panel-minimap-highlight";function W(){const s=E();function o(i,r){return r.fieldsets[i].icon??V[i]??"box"}function n(i,r){var f;const{content:a,type:v}=i;switch(v){case"heading":return x(a.text);case"text":return x(a.text);case"image":return a.alt||s.t("field.blocks.image.name");case"gallery":return(f=a.images)!=null&&f.length?`${s.t("field.blocks.gallery.name")} (${a.images.length})`:s.t("field.blocks.gallery.name");case"video":return x(a.caption)||s.t("field.blocks.video.name");case"code":return s.t("field.blocks.code.name")+(a.language?` (${a.language})`:"");case"quote":return x(a.text)||x(a.citation)||s.t("field.blocks.quote.name");case"markdown":return a.text?x(a.text):s.t("field.blocks.markdown.name");case"list":return s.t("field.blocks.list.name");case"line":return s.t("field.blocks.line.name");case"table":return s.t("field.blocks.table.name");default:return r.fieldsets[v].name??v.charAt(0).toUpperCase()+v.slice(1)}}function t(i){var a;if(!i)return;const r=document.querySelector(`[data-id="${i}"]`);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),r.classList.add(j),setTimeout(()=>{r.classList.remove(j)},2e3),(a=window.matchMedia)!=null&&a.call(window,"(max-width: 60rem)").matches&&s.menu.close())}return{getBlockIcon:o,extractBlockText:n,scrollToBlock:t}}function x(s,o=50){return s?s.replace(/<[^>]*>/g,"").substring(0,o):""}function Y(s,o,n,t){let i;const r=()=>{i==null||i(),i=void 0},a=(g,d,h,b)=>(g.addEventListener(d,h,b),()=>g.removeEventListener(d,h,b)),v=O(()=>H(s),g=>{r(),g&&(i=a(g,o,n,t))},{immediate:!0,flush:"post"}),f=()=>{v(),r()};return M()&&A(f),f}function G(s={}){const o=new WeakMap,n=new Set;let t;const{root:i,rootMargin:r="0px",threshold:a=.5}=s,v=()=>{if(t){for(const d of n)t.unobserve(d);n.clear(),t=void 0}},f=(d,h)=>(t??(t=new IntersectionObserver(b=>{for(const w of b){const k=o.get(w.target);k&&k(w.isIntersecting)}},{root:i,rootMargin:r,threshold:a})),d&&(o.set(d,h),n.add(d),t.observe(d)),()=>{d&&(t==null||t.unobserve(d),n.delete(d),o.delete(d))}),g=d=>{d&&(t==null||t.unobserve(d),n.delete(d),o.delete(d))};return M()&&A(v),{observe:f,unobserve:g,disconnect:v}}function H(s){const o=z(s);return(o==null?void 0:o.$el)??o}function X(s,o,n,t,i,r,a,v){var f=typeof s=="function"?s.options:s;return o&&(f.render=o,f.staticRenderFns=n,f._compiled=!0),{exports:s,options:f}}const J={__name:"MinimapSidebar",setup(s){const o=["gap","hidden","line"],n="kirby$minimap",t=E(),{currentContent:i,contentChanges:r}=K(),{getBlockIcon:a,extractBlockText:v,scrollToBlock:f}=W(),g=_(),d=_(),h=_(localStorage.getItem(n)==="true"||!1),b=_({}),w=_([]),k=_([]),C=new Set,ne=y(()=>Object.fromEntries(Object.entries(b.value).map(([c,u])=>{const l=r.value[c]??i.value[c],p=u.type==="blocks"&&Array.isArray(l)?l.filter(m=>!o.includes(m.type)).map(m=>({...m,_icon:a(m.type,u),_text:v(m,u),_active:k.value.includes(m.id)})):[];return[c,{...u,blocks:p,_active:w.value.includes(u.name)}]})));Y(g,"click",c=>{var u;c.stopPropagation(),(u=d.value)!=null&&u.$el.contains(c.target)&&F()});const S=G({rootMargin:"0px",threshold:0});O(h,c=>{localStorage.setItem(n,c),$(c)}),O([i,r],()=>{T()},{deep:!0}),O([()=>t.view.path,()=>t.view.props.tab],async()=>{q(),await L()},{immediate:!0}),P();function P(){$(h.value);const c=document.querySelector(".k-header"),u=c?c.getBoundingClientRect().top+Number.parseFloat(getComputedStyle(c).paddingTop):0;I("--minimap-top-offset",`${u}px`)}async function L(){if(t.view.path!=="site"&&!t.view.path.startsWith("pages/"))return;t.isLoading&&await new Promise(l=>{const p=O(()=>t.isLoading,()=>{U(()=>p()),l()})});const c=await t.api.get("__minimap__/model-fields",{id:t.view.path},void 0,!0);let u=c;if(t.view.props.tabs&&t.view.props.tabs.length>1){const l=N();u=Object.fromEntries(Object.entries(c).filter(([p])=>l.has(p)))}for(const[l,p]of Object.entries(u))o.includes(p.type)&&delete u[l];b.value=u;for(const l of Object.keys(b.value)){const p=document.querySelector(`.k-field-name-${l}`);p&&S.observe(p,m=>{m?w.value.push(l):w.value=w.value.filter(B=>B!==l)})}T()}function q(){S&&(S.disconnect(),w.value=[],k.value=[],C.clear())}function T(){if(!S)return;const c=new Set;for(const l of Object.values(b.value)){if(l.type!=="blocks")continue;const p=r.value[l.name]??i.value[l.name];if(Array.isArray(p))for(const m of p){if(c.add(m.id),C.has(m.id))continue;const B=document.querySelector(`[data-id="${m.id}"]`);B&&(S.observe(B,se=>{se?k.value.push(m.id):k.value=k.value.filter(ie=>ie!==m.id)}),C.add(m.id))}}const u=[...C].filter(l=>!c.has(l));if(u.length){k.value=k.value.filter(l=>!u.includes(l));for(const l of u)C.delete(l)}}function F(){h.value=!h.value}function $(c=!1){I("--minimap-width",c?"var(--minimap-width-open)":"var(--minimap-width-closed)")}function I(c,u){document.documentElement.style.setProperty(c,u)}function N(){const c=new Set,u=Array.isArray(t.view.props.tab.columns)?t.view.props.tab.columns:Object.values(t.view.props.tab.columns);for(const l of u)for(const p of Object.values(l.sections))if(p.type==="fields")for(const m of Object.values(p.fields))c.add(m.name);return c}function oe(c){var l;const u=document.querySelector(`.k-field-name-${c}`);u&&(u.scrollIntoView({behavior:"smooth",block:"center"}),(l=window.matchMedia)!=null&&l.call(window,"(max-width: 60rem)").matches&&t.menu.close())}return{__sfc:!0,EXCLUDED_FIELD_TYPES:o,OPEN_STATE_STORAGE_KEY:n,panel:t,currentContent:i,contentChanges:r,getBlockIcon:a,extractBlockText:v,scrollToBlock:f,minimap:g,toggleButton:d,isOpen:h,fields:b,activeFieldNames:w,activeBlockIds:k,observedBlockIds:C,resolvedFields:ne,observer:S,initializeMinimapUI:P,initializeMinimapContent:L,cleanupObservers:q,updateBlockObservers:T,toggle:F,updateMinimapWidth:$,setCssProperty:I,extractCurrentTabFieldNames:N,scrollToField:oe}}};var Q=function(){var o=this,n=o._self._c,t=o._self._setupProxy;return n("nav",{ref:"minimap",staticClass:"k-panel-minimap"},[n("div",{staticClass:"k-panel-minimap-body"},[n("menu",[o._l(Object.values(t.resolvedFields),function(i){return[n("div",{key:i.name},[n("div",{staticClass:"k-panel-minimap-menu-item",class:[t.isOpen?"km-py-[var(--spacing-2)]":"km-py-[var(--spacing-3)]"],attrs:{"data-active":String(i._active)},on:{click:function(r){return t.scrollToField(i.name)}}},[t.isOpen?[n("span",{staticClass:"k-label-text km-font-[var(--font-semi)]"},[o._v(" "+o._s(i.label)+" ")]),i.required?n("span",{staticClass:"km-font-[var(--font-semi)] km-text-[var(--theme-color-600)] km-ms-[var(--spacing-1)]",attrs:{title:t.panel.t("field.required"),"data-theme":"negative"},domProps:{textContent:o._s("âœ¶")}}):o._e()]:n("div",{staticClass:"km-h-px km-flex-1 km-bg-[var(--color-text)]"})],2),i.type==="blocks"&&i.blocks.length?o._l(i.blocks,function(r,a){return n("div",{key:`${a}-${r.id}`,staticClass:"k-panel-minimap-menu-item km-flex km-py-[var(--spacing-1)] km-items-center km-gap-[var(--spacing-2)]",attrs:{"data-active":String(r._active)},on:{click:function(v){return t.scrollToBlock(r.id)}}},[n("k-icon",{attrs:{type:r._icon}}),n("span",{staticClass:"k-label-text"},[o._v(" "+o._s(r._text)+" ")])],1)}):o._e()],2)]})],2)]),n("k-button",{ref:"toggleButton",staticClass:"k-panel-minimap-toggle",attrs:{icon:t.isOpen?"angle-right":"angle-left",title:t.isOpen?t.panel.t("collapse"):t.panel.t("expand"),size:"xs"}})],1)},Z=[],ee=X(J,Q,Z);const te=ee.exports;window.panel.plugin("johannschopplich/minimap",{use:[function(o){let n;o.mixin({mounted(){if(this.$options.name!=="k-panel-inside")return;const t=o.extend(te);n=new t({parent:this}),n.$mount(),this.$el.appendChild(n.$el)},beforeDestroy(){this.$options.name==="k-panel-inside"&&n&&(n.$destroy(),n=void 0)}})}]})})();
