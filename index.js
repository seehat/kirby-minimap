(function(){"use strict";const e=window.Vue;function E(){return window.panel}const R=()=>window.panel.plugins.viewButtons!==void 0;function D(){return R()?new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}}):E().app.$store}function K(){const s=E(),o=D(),n=R();if(n&&!("diff"in s.content))throw new Error("This plugin requires Kirby 5.0.0-rc.1 or higher. Please update your Kirby installation.");const t=y(n?()=>s.content.version("changes"):()=>o.getters["content/values"]()),a=y(n?()=>s.content.diff():()=>o.getters["content/changes"]()),i=y(n?()=>s.content.hasDiff():()=>o.getters["content/hasChanges"]()),d=n?s.content:new Proxy({},{get(){return()=>{}}});return{content:d,currentContent:t,contentChanges:a,hasChanges:i,update:async(p,g=!0)=>{if(!n&&p)for(const[h,b]of Object.entries(p))o.dispatch("content/update",[h,b]);const u=d.merge(p);g&&await d.save(u)}}}const y=e.computed;e.customRef,e.defineAsyncComponent,e.defineComponent,e.effectScope,e.getCurrentInstance;const M=e.getCurrentScope;e.h,e.inject,e.isProxy,e.isReactive,e.isReadonly,e.isRef,e.isShallow,e.markRaw;const U=e.nextTick;e.onActivated,e.onBeforeMount,e.onBeforeUnmount,e.onBeforeUpdate,e.onDeactivated,e.onErrorCaptured,e.onMounted,e.onRenderTracked,e.onRenderTriggered;const A=e.onScopeDispose;e.onServerPrefetch,e.onUnmounted,e.onUpdated,e.provide,e.proxyRefs,e.reactive,e.readonly;const _=e.ref;e.shallowReactive,e.shallowReadonly,e.shallowRef,e.toRaw,e.toRef,e.toRefs,e.triggerRef;const z=e.unref;e.useAttrs,e.useCssModule,e.useCssVars,e.useListeners,e.useSlots;const O=e.watch;e.watchEffect,e.watchPostEffect,e.watchSyncEffect;const V={heading:"title",text:"text",image:"image",gallery:"dashboard",video:"video",code:"code",quote:"quote",markdown:"markdown",list:"list-bullet",line:"divider",table:"menu"},j="k-panel-minimap-highlight";function W(){const s=E();function o(a){return V[a]??"box"}function n(a){var v;const{content:i,type:d}=a;switch(d){case"heading":return x(i.text);case"text":return x(i.text);case"image":return i.alt||s.t("field.blocks.image.name");case"gallery":return(v=i.images)!=null&&v.length?`${s.t("field.blocks.gallery.name")} (${i.images.length})`:s.t("field.blocks.gallery.name");case"video":return x(i.caption)||s.t("field.blocks.video.name");case"code":return s.t("field.blocks.code.name")+(i.language?` (${i.language})`:"");case"quote":return x(i.text)||x(i.citation)||s.t("field.blocks.quote.name");case"markdown":return i.text?x(i.text):s.t("field.blocks.markdown.name");case"list":return s.t("field.blocks.list.name");case"line":return s.t("field.blocks.line.name");case"table":return s.t("field.blocks.table.name");default:return d.charAt(0).toUpperCase()+d.slice(1)}}function t(a){var d;if(!a)return;const i=document.querySelector(`[data-id="${a}"]`);i&&(i.scrollIntoView({behavior:"smooth",block:"center"}),i.classList.add(j),setTimeout(()=>{i.classList.remove(j)},2e3),(d=window.matchMedia)!=null&&d.call(window,"(max-width: 60rem)").matches&&s.menu.close())}return{getBlockIcon:o,extractBlockText:n,scrollToBlock:t}}function x(s,o=50){return s?s.replace(/<[^>]*>/g,"").substring(0,o):""}function Y(s,o,n,t){let a;const i=()=>{a==null||a(),a=void 0},d=(g,u,h,b)=>(g.addEventListener(u,h,b),()=>g.removeEventListener(u,h,b)),v=O(()=>H(s),g=>{i(),g&&(a=d(g,o,n,t))},{immediate:!0,flush:"post"}),p=()=>{v(),i()};return M()&&A(p),p}function G(s={}){const o=new WeakMap,n=new Set;let t;const{root:a,rootMargin:i="0px",threshold:d=.5}=s,v=()=>{if(t){for(const u of n)t.unobserve(u);n.clear(),t=void 0}},p=(u,h)=>(t??(t=new IntersectionObserver(b=>{for(const w of b){const k=o.get(w.target);k&&k(w.isIntersecting)}},{root:a,rootMargin:i,threshold:d})),u&&(o.set(u,h),n.add(u),t.observe(u)),()=>{u&&(t==null||t.unobserve(u),n.delete(u),o.delete(u))}),g=u=>{u&&(t==null||t.unobserve(u),n.delete(u),o.delete(u))};return M()&&A(v),{observe:p,unobserve:g,disconnect:v}}function H(s){const o=z(s);return(o==null?void 0:o.$el)??o}function X(s,o,n,t,a,i,d,v){var p=typeof s=="function"?s.options:s;return o&&(p.render=o,p.staticRenderFns=n,p._compiled=!0),{exports:s,options:p}}const J={__name:"MinimapSidebar",setup(s){const o=["gap","hidden","line"],n="kirby$minimap",t=E(),{currentContent:a,contentChanges:i}=K(),{getBlockIcon:d,extractBlockText:v,scrollToBlock:p}=W(),g=_(),u=_(),h=_(localStorage.getItem(n)==="true"||!1),b=_({}),w=_([]),k=_([]),C=new Set,ne=y(()=>Object.fromEntries(Object.entries(b.value).map(([r,l])=>{const c=i.value[r]??a.value[r],m=l.type==="blocks"&&Array.isArray(c)?c.filter(f=>!o.includes(f.type)).map(f=>({...f,_icon:d(f.type),_text:v(f),_active:k.value.includes(f.id)})):[];return[r,{...l,blocks:m,_active:w.value.includes(l.name)}]})));Y(g,"click",r=>{var l;r.stopPropagation(),(l=u.value)!=null&&l.$el.contains(r.target)&&F()});const S=G({rootMargin:"0px",threshold:0});O(h,r=>{localStorage.setItem(n,r),$(r)}),O([a,i],()=>{T()},{deep:!0}),O([()=>t.view.path,()=>t.view.props.tab],async()=>{q(),await L()},{immediate:!0}),P();function P(){$(h.value);const r=document.querySelector(".k-header"),l=r?r.getBoundingClientRect().top+Number.parseFloat(getComputedStyle(r).paddingTop):0;I("--minimap-top-offset",`${l}px`)}async function L(){if(t.view.path!=="site"&&!t.view.path.startsWith("pages/"))return;t.isLoading&&await new Promise(c=>{const m=O(()=>t.isLoading,()=>{U(()=>m()),c()})});const r=await t.api.get("__minimap__/model-fields",{id:t.view.path},void 0,!0);let l=r;if(t.view.props.tabs&&t.view.props.tabs.length>1){const c=N();l=Object.fromEntries(Object.entries(r).filter(([m])=>c.has(m)))}for(const[c,m]of Object.entries(l))o.includes(m.type)&&delete l[c];b.value=l;for(const c of Object.keys(b.value)){const m=document.querySelector(`.k-field-name-${c}`);m&&S.observe(m,f=>{f?w.value.push(c):w.value=w.value.filter(B=>B!==c)})}T()}function q(){S&&(S.disconnect(),w.value=[],k.value=[],C.clear())}function T(){if(!S)return;const r=new Set;for(const c of Object.values(b.value)){if(c.type!=="blocks")continue;const m=i.value[c.name]??a.value[c.name];if(Array.isArray(m))for(const f of m){if(r.add(f.id),C.has(f.id))continue;const B=document.querySelector(`[data-id="${f.id}"]`);B&&(S.observe(B,ie=>{ie?k.value.push(f.id):k.value=k.value.filter(se=>se!==f.id)}),C.add(f.id))}}const l=[...C].filter(c=>!r.has(c));if(l.length){k.value=k.value.filter(c=>!l.includes(c));for(const c of l)C.delete(c)}}function F(){h.value=!h.value}function $(r=!1){I("--minimap-width",r?"var(--minimap-width-open)":"var(--minimap-width-closed)")}function I(r,l){document.documentElement.style.setProperty(r,l)}function N(){const r=new Set,l=Array.isArray(t.view.props.tab.columns)?t.view.props.tab.columns:Object.values(t.view.props.tab.columns);for(const c of l)for(const m of Object.values(c.sections))if(m.type==="fields")for(const f of Object.values(m.fields))r.add(f.name);return r}function oe(r){var c;const l=document.querySelector(`.k-field-name-${r}`);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),(c=window.matchMedia)!=null&&c.call(window,"(max-width: 60rem)").matches&&t.menu.close())}return{__sfc:!0,EXCLUDED_FIELD_TYPES:o,OPEN_STATE_STORAGE_KEY:n,panel:t,currentContent:a,contentChanges:i,getBlockIcon:d,extractBlockText:v,scrollToBlock:p,minimap:g,toggleButton:u,isOpen:h,fields:b,activeFieldNames:w,activeBlockIds:k,observedBlockIds:C,resolvedFields:ne,observer:S,initializeMinimapUI:P,initializeMinimapContent:L,cleanupObservers:q,updateBlockObservers:T,toggle:F,updateMinimapWidth:$,setCssProperty:I,extractCurrentTabFieldNames:N,scrollToField:oe}}};var Q=function(){var o=this,n=o._self._c,t=o._self._setupProxy;return n("nav",{ref:"minimap",staticClass:"k-panel-minimap"},[n("div",{staticClass:"k-panel-minimap-body"},[n("menu",[o._l(Object.values(t.resolvedFields),function(a){return[n("div",{key:a.name},[n("div",{staticClass:"k-panel-minimap-menu-item",class:[t.isOpen?"km-py-[var(--spacing-2)]":"km-py-[var(--spacing-3)]"],attrs:{"data-active":String(a._active)},on:{click:function(i){return t.scrollToField(a.name)}}},[t.isOpen?[n("span",{staticClass:"k-label-text km-font-[var(--font-semi)]"},[o._v(" "+o._s(a.label)+" ")]),a.required?n("span",{staticClass:"km-font-[var(--font-semi)] km-text-[var(--theme-color-600)] km-ms-[var(--spacing-1)]",attrs:{title:t.panel.t("field.required"),"data-theme":"negative"},domProps:{textContent:o._s("âœ¶")}}):o._e()]:n("div",{staticClass:"km-h-px km-flex-1 km-bg-[var(--color-text)]"})],2),a.type==="blocks"&&a.blocks.length?o._l(a.blocks,function(i,d){return n("div",{key:`${d}-${i.id}`,staticClass:"k-panel-minimap-menu-item km-flex km-py-[var(--spacing-1)] km-items-center km-gap-[var(--spacing-2)]",attrs:{"data-active":String(i._active)},on:{click:function(v){return t.scrollToBlock(i.id)}}},[n("k-icon",{attrs:{type:i._icon}}),n("span",{staticClass:"k-label-text"},[o._v(" "+o._s(i._text)+" ")])],1)}):o._e()],2)]})],2)]),n("k-button",{ref:"toggleButton",staticClass:"k-panel-minimap-toggle",attrs:{icon:t.isOpen?"angle-right":"angle-left",title:t.isOpen?t.panel.t("collapse"):t.panel.t("expand"),size:"xs"}})],1)},Z=[],ee=X(J,Q,Z);const te=ee.exports;window.panel.plugin("johannschopplich/minimap",{use:[function(o){let n;o.mixin({mounted(){if(this.$options.name!=="k-panel-inside")return;const t=o.extend(te);n=new t({parent:this}),n.$mount(),this.$el.appendChild(n.$el)},beforeDestroy(){this.$options.name==="k-panel-inside"&&n&&(n.$destroy(),n=void 0)}})}]})})();
